<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VolleySuite ‚Ä¢ Sorteggio + Playercard + Campo</title>
  <!-- Libreria per Excel (solo se si caricano .xlsx/.xls) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  <style>
    :root{
      --bg:#0d1015; --panel:#141922; --muted:#98a2ad; --text:#e9eef4; --acc:#5ac8fa;
      --ok:#3ddc97; --warn:#ffb703; --danger:#ef476f; --line:#273041; --card:#19202b;
      --court:#1d2431; --net:#a6adb7; --shadow:0 10px 30px rgba(0,0,0,.3);
      --radius:16px; --soft:#242b36;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f15,#0d1015 30%,#0b0f15);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{position:sticky;top:0;z-index:20;background:#0e131aee;border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:1200px;margin:auto;padding:12px 16px}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .tag{font-size:12px;color:#b7c1cc;border:1px solid var(--line);padding:3px 8px;border-radius:99px}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tab{border:1px solid var(--line);background:var(--card);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#293242,#1f2837);outline:2px solid #2f394b}

    main{max-width:1200px;margin:18px auto;padding:0 16px 80px;display:grid;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .panel .bd{padding:14px 16px}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 260px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input[type="text"], input[type="number"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text)}
    input::placeholder{color:#7f8a96}
    .btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg,#66d4ff,#48c0f3);color:#03121c;border-color:#0b4b69;font-weight:800}
    .btn.good{background:linear-gradient(180deg,#54e1ad,#3cd495);color:#042116;border-color:#08784f;font-weight:800}
    .btn.warn{background:linear-gradient(180deg,#ffb703,#e29b05);color:#241600;border-color:#a86f00;font-weight:800}
    .btn.small{padding:6px 10px;border-radius:10px;font-size:12px}
    .pill{font:12px/1.1 system-ui; padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:var(--card);color:#c6d0db}
    .hint{font-size:12px;color:#b8c2cc}
    .ok{color:var(--ok)} .warnTxt{color:var(--warn)} .danger{color:var(--danger)}

    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.g2,.g3,.g4{grid-template-columns:1fr}}

    /* Sorteggio */
    .inputs{display:grid;grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:8px}
    .input{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px}
    .input label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .input .row{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .input input[type="number"]{width:90px; padding:8px 10px; border-radius:10px; border:1px solid #2a3038;background:#0f1217; color:var(--text)}
    .badge{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #303540; background:#121720; color:#b9c3cf}
    .teams{display:grid; grid-template-columns:1fr; gap:16px}
    @media (min-width:700px){ .teams{grid-template-columns:1fr 1fr} }
    .team{background:linear-gradient(180deg,#171b23,#141820); border:1px solid var(--line); border-radius:16px; padding:12px}
    .team h3{margin:0 0 8px; font-size:14px}
    .list{display:grid; gap:8px}
    .player{display:flex; align-items:center; justify-content:space-between; gap:8px;background:#121721; border:1px solid #262c36; border-radius:12px; padding:10px}
    .left{display:flex; align-items:center; gap:10px}
    .role{width:26px; height:26px; border-radius:8px; display:grid; place-items:center; font-weight:800; font-size:12px;background:#10151d; border:1px solid #2a303a; color:#a7b8ca}
    .name{font-size:13px}
    .id{font-size:11px; color:#8fa1b3}
    .status{margin-top:8px; font-size:12px}

    /* Playercard */
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #222831;text-align:center}
    th{background:#12161c}
    .posgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .poscell{background:#11161d;border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center}
    .poscell b{display:block;font-size:11px;color:#9aa3ad}
    .invalid{outline:2px solid var(--danger)}

    /* Campo */
    .court-wrap{display:grid;grid-template-columns:1fr;gap:16px}
    .score{display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap}
    .score .team{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px 12px;background:var(--card);border:1px solid var(--line);border-radius:12px;min-width:260px}
    .score .team .name{font-weight:700}
    .score .team .pts{font-size:28px;font-weight:800}
    .serve{width:10px;height:10px;border-radius:99px;background:var(--ok);box-shadow:0 0 0 4px rgba(61,220,151,.2)}
    .court{position:relative;background:var(--court);border:1px solid var(--line);border-radius:18px;padding:16px}
    .half{display:grid;grid-template-rows:auto 1fr;gap:10px}
    .half + .half{margin-top:16px}
    .team-hd{display:flex;align-items:center;justify-content:space-between}
    .net{position:absolute;left:16px;right:16px;top:50%;height:6px;background:repeating-linear-gradient(90deg,#e2e6eb 0 6px,#aab3bd 6px 10px);border-top:1px solid #c2c8cf;border-bottom:1px solid #8893a0;opacity:.9;transform:translateY(-50%);border-radius:2px}
    .six{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,110px);gap:10px}
    .cell{position:relative;background:linear-gradient(180deg,#202938,#1b2330);border:1px solid var(--line);border-radius:14px;padding:8px;display:flex;flex-direction:column;justify-content:space-between}
    .pos{position:absolute;top:6px;left:8px;font-size:11px;color:#9fb1c3;background:#0b1119cc;padding:2px 6px;border-radius:8px;border:1px solid #253146}
    .who{font-weight:700}
    .roleMini{font-size:12px;color:#b7c1cc}
    .stats{display:flex;gap:8px;font-size:12px;color:#cfd7e0}
    .stats .label{color:#9fb1c3}
    .missing{outline:2px dashed #f39;border-color:#f39}

    dialog{border:none;border-radius:16px;background:#121824;color:var(--text);padding:18px 16px;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
	/* Header cell: Nome + [ID] su una riga, Posizione sotto */
.cell .pos{ display:none }          /* nasconde il vecchio badge assoluto */
.whoRow{ display:flex; align-items:baseline; gap:8px; }
.whoRow .nm{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.whoRow .pid{ font-size:12px; color:#9fb1c3 }
.posSmall{ margin-top:2px; font-size:11px; color:#9fb1c3 }
.roleMini{ margin-top:4px }         /* un filo di respiro sotto la posizione */
	
	/* ‚Äî‚Äî‚Äî Side calc panels ‚Äî‚Äî‚Äî */
    .courtWrap{ display:grid; grid-template-columns:260px 1fr 260px; gap:12px; align-items:start }
    .sidecalc{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:12px; box-shadow:var(--shadow); position:sticky; top:74px }
    .sidecalc .group{ margin-bottom:12px }
    .sidecalc .group-hd{ font-weight:700; margin-bottom:8px }
    .sidecalc .idrow{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0 }
    .sidecalc .idrow input{ width:110px; padding:6px 8px; background:#0f141a; color:var(--text);
      border:1px solid var(--line); border-radius:10px }
    .sidecalc .statline{ font-size:12px; opacity:.85; display:flex; flex-wrap:wrap; gap:10px }
    .sidecalc .statline b{ font-variant-numeric:tabular-nums }
    .sidecalc .divider{ height:1px; background:var(--line); margin:8px 0 }
    .sidecalc .result{ margin-top:6px; font-weight:700 }
    .sidecalc .hint{ font-size:11px; opacity:.7; margin-left:8px }
      @media (max-width:1100px){
    .courtWrap{ grid-template-columns:1fr; }
    .sidecalc{ position:static }
	
	/* === Mazzo azioni (Campo) === */
.cardsbox{
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:12px; box-shadow:var(--shadow); grid-column:1 / -1; display:grid; gap:10px
}
.cards_head{display:flex; align-items:center; justify-content:space-between; gap:12px}
.cards_list{display:flex; flex-wrap:wrap; gap:8px}
.cardchip{padding:6px 8px; border-radius:12px; border:1px solid var(--line); background:#121822; font-size:12px}
.cardchip b{margin-left:6px; font-variant-numeric:tabular-nums}
.cardview{padding:14px; border:1px dashed var(--line); border-radius:12px;
  background:linear-gradient(180deg,#1e2836,#18202d)}
.cardview .name{font-weight:800; font-size:15px}
.cardview .effect{font-size:12px; color:#b7c1cc; margin-top:4px}

}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="align-items:center;gap:10px">
          <h1>VolleySuite</h1>
          <span class="tag">Sorteggio ‚Ä¢ Playercard ‚Ä¢ Campo</span>
        </div>
        <div class="row">
          <span id="dsStatus" class="pill">Sorgente: in attesa‚Ä¶</span>
          <button id="btnReloadPlayers" class="btn small">Ricarica players.json</button>
          <label class="btn small" for="fileInput">Carica JSON/Excel</label>
          <input id="fileInput" type="file" accept=".json,.xlsx,.xls,.csv" hidden>
          <button id="btnSaveAll" class="btn small good">Salva progetto</button>
          <button id="btnResetAll" class="btn small">Reset</button>
        </div>
      </div>
      <nav class="tabs" id="topTabs"></nav>
    </div>
  </header>

  <main>
    <!-- ====== TAB: SORTEGGIO ====== -->
    <section class="panel" data-tab="sorteggio">
      <div class="hd">
        <strong>Sorteggio 2 Squadre per Ruolo</strong>
        <div class="row">
          <span class="pill" id="poolInfo">‚Äî</span>
          <button class="btn small" id="btnSendToPlayercard" title="Invia i roster alle Playercard">Invia a Playercard</button>
          <button class="btn small" id="btnSendToCampo" title="Invia rotazioni auto ‚Üí Campo">Invia a Campo (Auto‚ÄëR1‚ÜíR6)</button>
        </div>
      </div>
      <div class="bd grid g2">
        <div class="panel" style="margin:0">
          <div class="hd"><strong>Input</strong></div>
          <div class="bd">
            <div class="inputs" id="roleInputs"></div>
            <div class="row" style="margin-top:10px;gap:8px">
              <button class="btn primary" id="drawBtn">Sorteggia 2 Squadre</button>
              <button class="btn" id="reshuffleBtn" disabled>Rigenera</button>
              <button class="btn" id="copyBtn" disabled>Copia</button>
              <button class="btn" id="csvBtn" disabled>Scarica CSV</button>
            </div>
            <div class="status hint" id="sortStatus" style="margin-top:10px">Pronto.</div>
          </div>
        </div>
        <div class="panel" style="margin:0">
          <div class="hd"><strong>Risultato</strong></div>
          <div class="bd">
            <div class="teams" id="teams">
              <div class="team" id="teamA"><h3>üèê Squadra A</h3><div class="list"></div></div>
              <div class="team" id="teamB"><h3>üèê Squadra B</h3><div class="list"></div></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ====== TAB: PLAYERCARD ====== -->
    <section class="panel" data-tab="playercard" hidden>
      <div class="hd">
        <strong>Playercard ‚Ä¢ Roster & Rotazioni</strong>
        <div class="row">
          <label class="pill">Team:
            <select id="pcTeamSel" style="margin-left:8px">
              <option value="A">A</option>
              <option value="B">B</option>
            </select>
          </label>
          <button class="btn small" id="btnAutoR1">Auto R1 (migliori stat)</button>
          <button class="btn small" id="btnToCampo">Invia rotazioni al Campo</button>
        </div>
      </div>
      <div class="bd">
        <div class="section">Roster (12)</div>
        <div id="pcRoster" class="grid g2"></div>
        <div class="section" style="margin-top:14px">Rotazioni (R1‚ÄìR6)</div>
        <div id="pcRotations" class="grid g3"></div>
        <div id="pcMsg" class="hint" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ====== TAB: CAMPO ====== -->
    <section class="panel" data-tab="campo" hidden>
      <div class="hd">
        <strong>Campo ‚Ä¢ Rotazioni R1‚ÄìR6 per ID</strong>
        <div class="row">
          <button class="btn small" id="btnImportFromPC">Sincronizza da Playercard</button>
          <span class="pill">Rot A: <b id="rotA">R1</b></span>
          <span class="pill">Rot B: <b id="rotB">R1</b></span>
        </div>
      </div>
      <div class="bd grid g2">
        <!-- Editor rotazioni A/B (come in Campo.html) -->
        <fieldset class="panel" style="margin:0">
          <div class="hd"><strong>Squadra A</strong></div>
          <div class="bd">
            <div class="tabs" id="tabsA"></div>
            <div id="formsA"></div>
          </div>
        </fieldset>
        <fieldset class="panel" style="margin:0">
          <div class="hd"><strong>Squadra B</strong></div>
          <div class="bd">
            <div class="tabs" id="tabsB"></div>
            <div id="formsB"></div>
          </div>
        </fieldset>
        <div class="row">
          <button class="btn primary" id="btnSaveRot">Salva rotazioni e mostra campo</button>
          <button class="btn" id="btnClearLS">Reset locale</button>
        </div>
      </div>

      <div class="bd court-wrap" id="playPanel" hidden>
        <div class="score">
          <div class="team" id="teamABox">
            <span class="serve" id="serveA" hidden></span>
            <span class="name">Squadra A</span>
            <button class="btn small good" id="plusA">+1</button>
            <span class="pts" id="ptsA">0</span>
            <button class="btn small" id="soA">Side‚ÄëOut A</button>
          </div>
          <div class="team" id="teamBBox">
            <span class="serve" id="serveB" hidden></span>
            <span class="name">Squadra B</span>
            <button class="btn small good" id="plusB">+1</button>
            <span class="pts" id="ptsB">0</span>
            <button class="btn small" id="soB">Side‚ÄëOut B</button>
          </div>
        </div>

        <div class="court">
          <div class="net" aria-hidden="true"></div>
          <div class="half">
            <div class="team-hd"><strong>Squadra A</strong><span class="hint">Sopra ‚Ä¢ SLD,SLC,SLS / sotto FD,FC,FS</span></div>
            <div class="six" id="sixA">
              <div class="cell" data-pos="SLD"><span class="pos">SLD</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="SLC"><span class="pos">SLC</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="SLS"><span class="pos">SLS</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="FD"><span class="pos">FD</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="FC"><span class="pos">FC</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="FS"><span class="pos">FS</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
            </div>
          </div>
          <div class="half">
            <div class="team-hd"><strong>Squadra B</strong><span class="hint">Sotto ‚Ä¢ FS,FC,FD / sotto SLS,SLC,SLD</span></div>
            <div class="six" id="sixB">
              <div class="cell" data-pos="FS"><span class="pos">FS</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="FC"><span class="pos">FC</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="FD"><span class="pos">FD</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="SLS"><span class="pos">SLS</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="SLC"><span class="pos">SLC</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
              <div class="cell" data-pos="SLD"><span class="pos">SLD</span><div class="who"></div><div class="roleMini"></div><div class="stats"></div></div>
            </div>
          </div>
        </div>
      </div>

      <dialog id="dlgServe">
        <form method="dialog">
          <h3 style="margin:0 0 10px">Chi inizia con il servizio?</h3>
          <div class="row"><button class="btn good" value="A">Inizia A</button><button class="btn good" value="B">Inizia B</button></div>
        </form>
      </dialog>
    </section>
  </main>

  <script>
  /********************
   *  CORE APP STATE  *
   ********************/
  const STORAGE_KEY = 'volley_suite_v1';
  const ROLES = ["S","R","L","OH","OPP","MB"];
  const POS_PC = ["FS","FC","FD","SLS","SLC","SLD"]; // Playercard
  const POS_CAMPO = ["SLS","SLC","SLD","FD","FC","FS"]; // Campo
  const FRONT_POS = new Set(["FS","FC","FD"]);
  const ROT_ORDER = ["FS","FC","FD","SLD","SLC","SLS"]; // giro in senso orario

  const App = {
    playersMap: {},  // id(string) -> {ID, FullName/Name, Role, ATK, BLK, DEF, SET, SERV}
    playersArr: [],  // [{id, name, role, ...}]
    sorteggio: null, // {A:[], B:[]}
    playercard: { A:{ roster:[], rotations: Array.from({length:6}, ()=>({})) }, B:{ roster:[], rotations: Array.from({length:6}, ()=>({})) } },
    campo: { A:{ rotations: Array.from({length:6}, ()=>Array(6).fill("")), idx:0, pts:0 }, B:{ rotations: Array.from({length:6}, ()=>Array(6).fill("")), idx:0, pts:0 }, serving:'A' }
  };

  // ---------- Utils ----------
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function pillStatus(msg, okClass){ const el = document.getElementById('dsStatus'); el.innerHTML = msg; if(okClass) el.className = 'pill '+okClass; }
  function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function normId(raw){ if(raw==null) return ""; const s=String(raw).trim().replace(/,/g,'.'); const n=Number(s); if(!Number.isNaN(n)){ const i=Math.round(n); if(Math.abs(n-i)<1e-9) return String(i); return String(n); } return s; }
  function toNum(v){ if(v==null||v==='') return 0; const n=Number(String(v).replace(',','.')); return Number.isFinite(n)?n:0; }

  // Ingestione dataset: gestisce array o mappa con chiavi numeriche (anche "1.0")
  function ingestPlayers(raw){
    const arr = Array.isArray(raw) ? raw : (raw && typeof raw==='object' ? Object.values(raw) : []);
    const m = {}; const a = [];
    for (let i=0;i<arr.length;i++){
      const r = arr[i]||{};
      // chiave flessibile
      const map = {}; Object.keys(r).forEach(k=>map[k.toLowerCase()] = k);
      const id = normId(r[map['id']] ?? (i+1));
      const name = (r[map['fullname']] ?? r[map['name']] ?? '').toString();
      const role = (r[map['role']] ?? '').toString().toUpperCase();
      const obj = {
        ID:id, Name:name || r.FullName || r.Name || '', Role:role,
        ATK:toNum(r.ATK ?? r[map['atk']]), BLK:toNum(r.BLK ?? r[map['blk']]),
        DEF:toNum(r.DEF ?? r[map['def']]), SET:toNum(r.SET ?? r[map['set']]), SERV:toNum(r.SERV ?? r[map['serv']])
      };
      if (!obj.Name) continue;
      m[id] = obj; a.push({id, name:obj.Name, role:role||r.Role||''});
    }
    App.playersMap = m; App.playersArr = a;
    updatePoolInfo();
  }

  async function autoLoadPlayers(){
    try{
      pillStatus('Carico <code>players.json</code>‚Ä¶');
      const res = await fetch('players.json', {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const raw = await res.json();
      ingestPlayers(raw);
      pillStatus('<span class="ok">players.json caricato</span>');
    }catch(e){ pillStatus('<span class="warnTxt">players.json non trovato ‚Ä¢ carica JSON/XLSX</span>'); }
  }

  // Salvataggio del progetto
  function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(App)); }
  function loadAll(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return false; const obj=JSON.parse(raw); if(!obj) return false; Object.assign(App,obj); return true; }catch(_){ return false; } }

  // ---------- Tabs ----------
  const TABS = [ {id:'sorteggio', label:'Sorteggio'}, {id:'playercard', label:'Playercard'}, {id:'campo', label:'Campo'} ];
  function buildTabs(){ const nav=$('#topTabs'); nav.innerHTML=''; for(const t of TABS){ const b=document.createElement('button'); b.className='tab'; b.textContent=t.label; b.dataset.tab=t.id; b.addEventListener('click', ()=>showTab(t.id)); nav.appendChild(b);} showTab('sorteggio'); }
  function showTab(id){ $$('.tab').forEach(b=>b.setAttribute('aria-selected', b.dataset.tab===id?'true':'false')); $$('main > section.panel').forEach(s=>{ s.hidden = s.dataset.tab!==id; }); }

  /********************
   *  SORTEGGIO LOGIC  * (ispirato al tuo Sorteggio.html)
   ********************/
  const roleState = {}; ROLES.forEach(r=>roleState[r]=0);
  function uiBuildRoleInputs(){ const box=$('#roleInputs'); box.innerHTML=''; ROLES.forEach(role=>{ const d=document.createElement('div'); d.className='input'; d.id='box-'+role; d.innerHTML=`<label>Ruolo ${role}</label><div class="row"><input type="number" min="0" step="1" value="0" id="qty-${role}"><span class="badge" id="avail-${role}">Disponibili: ‚Äî</span></div>`; box.appendChild(d); $('#qty-'+role).addEventListener('input', e=>{ roleState[role]=+e.target.value||0; validateCounts(); }); }); }
  function groupByRole(){ const m=new Map(); for(const p of App.playersArr){ if(!m.has(p.role)) m.set(p.role,[]); m.get(p.role).push(p);} return m; }
  function updatePoolInfo(){ const g=groupByRole(); const tot=App.playersArr.length; const inf=$('#poolInfo'); if(!inf) return; inf.innerHTML = `<span class="pill">Giocatori: ${tot}</span> ` + ROLES.map(r=>`<span class="pill">${r}: ${(g.get(r)||[]).length}</span>`).join(' ');
    ROLES.forEach(r=>{ const n=(g.get(r)||[]).length; const b=$('#avail-'+r); if(b) b.textContent='Disponibili: '+n; }); }
  function validateCounts(){ const g=groupByRole(); let ok=true; const msgs=[]; ROLES.forEach(r=>{ const need=(roleState[r]||0)*2; const have=(g.get(r)||[]).length; const box=$('#box-'+r); if(need>0 && have<need){ ok=false; if(box) box.style.borderColor='var(--danger)'; msgs.push(`${r}: servono ${need}, disp ${have}`);} else if(box){ box.style.borderColor='var(--line)'; } }); const st=$('#sortStatus'); if(!App.playersArr.length){ if(st) st.textContent='Carica un dataset per procedere.'; return false; } if(!ok){ if(st) st.innerHTML=`<span class="danger">Non basta il pool</span>: ${msgs.join(' ‚Ä¢ ')}`; return false; } const sum = Object.values(roleState).reduce((a,b)=>a+(+b||0),0); if(st) st.innerHTML = `Pronto: 2 squadre da <b>${sum}</b> giocatori.`; return true; }
  function cryptoShuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const r=new Uint32Array(1); crypto.getRandomValues(r); const j=r[0]%(i+1); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function drawTeams(){ if(!validateCounts()) return; const g=groupByRole(); const used=new Set(); const A=[], B=[]; for(const role of ROLES){ const perTeam=roleState[role]||0; if(perTeam===0) continue; const pool=cryptoShuffle(g.get(role)||[]); const need=perTeam*2; const pick=pool.slice(0,need); const sh=cryptoShuffle(pick); const a=sh.slice(0,perTeam), b=sh.slice(perTeam,perTeam*2); for(const p of a){ if(used.has(p.id)) throw new Error('Doppione A: '+p.id); used.add(p.id); A.push(p);} for(const p of b){ if(used.has(p.id)) throw new Error('Doppione B: '+p.id); used.add(p.id); B.push(p);} }
    const ord=i=>ROLES.indexOf(i.role); A.sort((x,y)=>ord(x)-ord(y)||x.name.localeCompare(y.name)); B.sort((x,y)=>ord(x)-ord(y)||x.name.localeCompare(y.name)); App.sorteggio = {A,B}; renderTeams(A,B); $('#reshuffleBtn').disabled=false; $('#copyBtn').disabled=false; $('#csvBtn').disabled=false; $('#sortStatus').innerHTML='<span class="ok">Fatto!</span> Sorteggio pronto.'; }
  function renderTeams(a,b){ function list(id,list){ const box=document.querySelector('#'+id+' .list'); box.innerHTML=''; for(const p of list){ const row=document.createElement('div'); row.className='player'; row.innerHTML=`<div class="left"><div class="role">${p.role}</div><div><div class="name">${escapeHtml(p.name)}</div><div class="id">ID: ${escapeHtml(p.id)}</div></div></div>`; box.appendChild(row);} } list('teamA',a); list('teamB',b); }
  function copyTeamsToClipboard(){ if(!App.sorteggio) return; const L=[]; L.push('Squadra A'); App.sorteggio.A.forEach(p=>L.push(`${p.role}\t${p.name}\t${p.id}`)); L.push(''); L.push('Squadra B'); App.sorteggio.B.forEach(p=>L.push(`${p.role}\t${p.name}\t${p.id}`)); navigator.clipboard.writeText(L.join('\n')); }
  function downloadCSV(){ if(!App.sorteggio) return; const rows=[["Team","ID","FullName","Role"]]; for(const p of App.sorteggio.A) rows.push(["A",p.id,p.name,p.role]); for(const p of App.sorteggio.B) rows.push(["B",p.id,p.name,p.role]); const csv=rows.map(r=>r.map(v=>String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sorteggio.csv'; document.body.appendChild(a); a.click(); a.remove(); }

  // Bridge: invia a Playercard (roster)
  function sendToPlayercard(){ if(!App.sorteggio){ alert('Fai prima un sorteggio.'); return; } App.playercard.A.roster = App.sorteggio.A.map(p=>p.id).slice(0,12); App.playercard.B.roster = App.sorteggio.B.map(p=>p.id).slice(0,12); showTab('playercard'); pcRefreshAll(); }
  // Bridge: invia a Campo con auto-R1‚ÜíR6 da Playercard
  function sendToCampo(){ if(!App.sorteggio){ alert('Fai prima un sorteggio.'); return; } sendToPlayercard(); autoComposeR1('A'); autoComposeR1('B'); pcPushRotationsToCampo(); showTab('campo'); }

  /**********************
   *  PLAYERCARD LOGIC  * (ispirato al tuo playercard.html)
   **********************/
  function pcTeam(){ return $('#pcTeamSel').value || 'A'; }
  function pcRosterContainer(){ return $('#pcRoster'); }
  function pcRotationsContainer(){ return $('#pcRotations'); }
  function pcMsg(msg, type){ const el=$('#pcMsg'); el.className='hint '+(type||''); el.textContent=msg||''; }
  function getPlayerById(id){ return App.playersMap[normId(id)] || App.playersMap[normId(id)+'.0'] || null; }
  function roleBlockedInFront(p){ const s=(p && p.Role||'').toUpperCase(); return s==='R' || s==='L'; }
  function pcBuildRoster(){ const root=pcRosterContainer(); root.innerHTML=''; for(let i=1;i<=12;i++){ const card=document.createElement('div'); card.className='panel'; card.innerHTML=`<div class="bd"><div class="grid g2"><div><label>ID</label><input type="text" data-pc-id="${i}" placeholder="es. 1" /></div><div><label>Nome</label><input type="text" data-pc-name="${i}" disabled/></div></div><div style="margin-top:10px"><table><thead><tr><th>ATK</th><th>BLK</th><th>DEF</th><th>SET</th><th>SERV</th></tr></thead><tbody><tr><td data-pc-atk="${i}">‚Äî</td><td data-pc-blk="${i}">‚Äî</td><td data-pc-def="${i}">‚Äî</td><td data-pc-set="${i}">‚Äî</td><td data-pc-serv="${i}">‚Äî</td></tr></tbody></table></div></div>`; root.appendChild(card); }
    for(let i=1;i<=12;i++){ const input = document.querySelector(`[data-pc-id="${i}"]`); input.addEventListener('input', ()=>{ pcFillRosterLine(i, input.value); pcRefreshRotationOptions(); }); } }
  function pcFillRosterLine(i, rawId){ const p=getPlayerById(rawId); const nameEl=$(`[data-pc-name="${i}"]`); const t={ atk:$(`[data-pc-atk="${i}"]`), blk:$(`[data-pc-blk="${i}"]`), def:$(`[data-pc-def="${i}"]`), set:$(`[data-pc-set="${i}"]`), serv:$(`[data-pc-serv="${i}"]`) }; if(!p){ nameEl.value=''; Object.values(t).forEach(el=>el.textContent='‚Äî'); return; } nameEl.value=p.Name; t.atk.textContent=p.ATK||0; t.blk.textContent=p.BLK||0; t.def.textContent=p.DEF||0; t.set.textContent=p.SET||0; t.serv.textContent=p.SERV||0; }
  function pcRosterEntries(){ const ids=[]; for(let i=1;i<=12;i++){ const v=$(`[data-pc-id="${i}"]`).value; const p=getPlayerById(v); if(p) ids.push({id:normId(v), name:p.Name}); } const seen=new Set(); return ids.filter(x=>{ if(seen.has(x.id)) return false; seen.add(x.id); return true; }); }
  function pcBuildRotations(){ const root=pcRotationsContainer(); root.innerHTML=''; for(let r=1;r<=6;r++){ const c=document.createElement('div'); c.className='panel'; const selects = `<div class="bd"><div class="posgrid">${POS_PC.map(pos=>`<div><label>${pos}</label><select data-pc-rot="${r}-${pos}"><option value="">‚Äî</option></select></div>`).join('')}</div></div>`; const aStats = POS_PC.map(pos=>`<div class="poscell"><b>${pos}</b><span data-pc-aks="${r}-${pos}">‚Äî/‚Äî</span></div>`).join(''); const bStats = POS_PC.map(pos=>`<div class="poscell"><b>${pos}</b><span data-pc-bds="${r}-${pos}">‚Äî/‚Äî/‚Äî</span></div>`).join(''); c.innerHTML = `<div class="hd"><strong>Rotazione R${r}</strong></div>${selects}<div class="bd grid g2"><div class="panel" style="margin:0"><div class="bd"><b>ATK/SET</b><div class="posgrid">${aStats}</div></div></div><div class="panel" style="margin:0"><div class="bd"><b>BLK/DEF/SERV</b><div class="posgrid">${bStats}</div></div></div></div>`; root.appendChild(c); }
    // listeners
    for(let r=1;r<=6;r++){
      for(const pos of POS_PC){ const sel=document.querySelector(`[data-pc-rot="${r}-${pos}"]`); sel.addEventListener('change', ()=>{ const pl=getPlayerById(sel.value); if(FRONT_POS.has(pos) && pl && roleBlockedInFront(pl)){ sel.value=''; pcMsg('Ruolo R/L non ammesso davanti', 'danger'); sel.classList.add('invalid'); setTimeout(()=>sel.classList.remove('invalid'),600); } enforceNoDupesPC(r); pcUpdateRotation(r); pcStoreRotations(); }); }
    }
  }
  function pcBuildOptionsForPos(entries, pos){ return ['<option value="">‚Äî</option>'].concat(entries.map(e=>{ const p=getPlayerById(e.id); const block=FRONT_POS.has(pos) && p && roleBlockedInFront(p); return `<option value="${e.id}" ${block?'disabled title="R/L esclusi"':''}>[${e.id}] ${escapeHtml(e.name)}</option>`; })).join(''); }
  function pcRefreshRotationOptions(){ const entries=pcRosterEntries(); for(let r=1;r<=6;r++){ for(const pos of POS_PC){ const sel=document.querySelector(`[data-pc-rot="${r}-${pos}"]`); const prev=sel.value; sel.innerHTML=pcBuildOptionsForPos(entries,pos); if(entries.some(e=>e.id===prev)){ const pl=getPlayerById(prev); if(!(FRONT_POS.has(pos)&&pl&&roleBlockedInFront(pl))) sel.value=prev; else sel.value=''; } else sel.value=''; } enforceNoDupesPC(r); pcUpdateRotation(r); } }
  function enforceNoDupesPC(r){ const sels=POS_PC.map(pos=>document.querySelector(`[data-pc-rot="${r}-${pos}"]`)); const used=new Set(sels.map(s=>s.value).filter(Boolean)); sels.forEach(sel=>{ Array.from(sel.options).forEach(opt=>{ if(!opt.value){ opt.disabled=false; return; } const mine=sel.value===opt.value; const dup=used.has(opt.value)&&!mine; const pos=sel.getAttribute('data-pc-rot').split('-')[1]; const p=getPlayerById(opt.value); const rlBlock=FRONT_POS.has(pos)&&p&&roleBlockedInFront(p); opt.disabled = dup || rlBlock; }); }); }
  function pcUpdateRotation(r){ for(const pos of POS_PC){ const sel=document.querySelector(`[data-pc-rot="${r}-${pos}"]`); const p=getPlayerById(sel.value); const a=$(`[data-pc-aks="${r}-${pos}"]`); const b=$(`[data-pc-bds="${r}-${pos}"]`); if(!p){ a.textContent='‚Äî/‚Äî'; b.textContent='‚Äî/‚Äî/‚Äî'; continue; } a.textContent=`${p.ATK||0}/${p.SET||0}`; b.textContent=`${p.BLK||0}/${p.DEF||0}/${p.SERV||0}`; } }

  // Auto R1 migliori + auto-fill R2..R6 (come nell'originale)
  function scoreTupleForPos(p,pos){ const ATK=p.ATK||0, BLK=p.BLK||0, DEF=p.DEF||0, SET=p.SET||0, SERV=p.SERV||0; switch(pos){ case 'FS': case 'FC': case 'FD': return [ATK+BLK, ATK, BLK]; case 'SLD': return [SERV+SET, SERV, SET]; case 'SLC': case 'SLS': return [DEF, ATK, BLK]; default: return [0]; } }
  function betterTuple(a,b){ for(let i=0;i<Math.max(a.length,b.length);i++){ const av=a[i]??-Infinity, bv=b[i]??-Infinity; if(av>bv) return true; if(av<bv) return false; } return false; }
  function candidatesForPos(entries,pos){ const selR1=document.querySelector(`[data-pc-rot="1-${pos}"]`); return entries.map(e=>({id:e.id,p:getPlayerById(e.id)})).filter(x=>x.p && (!FRONT_POS.has(pos) || !roleBlockedInFront(x.p))).filter(x=>Array.from(selR1.options).some(o=>o.value===x.id)).map(x=>({id:x.id,p:x.p,t:scoreTupleForPos(x.p,pos)})).sort((a,b)=> betterTuple(b.t,a.t)?1:betterTuple(a.t,b.t)?-1:0); }
  function autoComposeR1(team){ const entries = pcRosterEntries(); const used=new Set(); for(const pos of ROT_ORDER){ const sel=$(`[data-pc-rot="1-${pos}"]`); if(!sel) continue; const cand=candidatesForPos(entries,pos).find(c=>!used.has(c.id)); sel.value = cand ? (used.add(cand.id), cand.id) : ''; }
    enforceNoDupesPC(1); pcUpdateRotation(1); autoFillFromR1(); pcStoreRotations(); pcMsg('R1 auto-composta + propagate R2‚ÄìR6'); }
  function autoFillFromR1(){ const src={}; for(const pos of ROT_ORDER){ const sel=$(`[data-pc-rot="1-${pos}"]`); src[pos]=sel?sel.value:''; }
    for(let r=2;r<=6;r++){ const k=(r-1)%ROT_ORDER.length; for(let i=0;i<ROT_ORDER.length;i++){ const from=ROT_ORDER[i]; const dest=ROT_ORDER[(i+k)%ROT_ORDER.length]; const val=src[from]; const destSel=$(`[data-pc-rot="${r}-${dest}"]`); if(!destSel) continue; if(!val){ destSel.value=''; continue; } const pl=getPlayerById(val); if(FRONT_POS.has(dest)&&pl&&roleBlockedInFront(pl)){ destSel.value=''; continue; } const hasOpt=Array.from(destSel.options).some(o=>o.value===val); destSel.value = hasOpt ? val : ''; }
      enforceNoDupesPC(r); pcUpdateRotation(r); }
  }

  // Persistenza (playercard -> App)
  function pcStoreRoster(){ const team=pcTeam(); const ids=pcRosterEntries().map(x=>x.id); App.playercard[team].roster = ids; }
  function pcStoreRotations(){ const team=pcTeam(); const rots=[]; for(let r=1;r<=6;r++){ const obj={}; for(const pos of POS_PC){ obj[pos] = $(`[data-pc-rot="${r}-${pos}"]`).value || ''; } rots.push(obj); } App.playercard[team].rotations = rots; saveAll(); }

  function pcLoadFromState(){ const team=pcTeam(); // roster
    for(let i=1;i<=12;i++){ const input=$(`[data-pc-id="${i}"]`); input.value = App.playercard[team].roster[i-1] || ''; pcFillRosterLine(i, input.value); }
    pcRefreshRotationOptions(); // rotazioni
    const rots=App.playercard[team].rotations||[]; for(let r=1;r<=6;r++){ const obj=rots[r-1]||{}; for(const pos of POS_PC){ const sel=$(`[data-pc-rot="${r}-${pos}"]`); if(sel){ const v=obj[pos]||''; const has = Array.from(sel.options).some(o=>o.value===v); sel.value = has? v: ''; } } pcUpdateRotation(r); enforceNoDupesPC(r); }
  }
  function pcPushRotationsToCampo(){ // mappa POS_PC -> POS_CAMPO ordine
    function objToArray(obj){ // POS_PC order to Campo order
      const map = { SLS:obj.SLS, SLC:obj.SLC, SLD:obj.SLD, FD:obj.FD, FC:obj.FC, FS:obj.FS };
      return [ map.SLS||'', map.SLC||'', map.SLD||'', map.FD||'', map.FC||'', map.FS||'' ];
    }
    ['A','B'].forEach(team=>{
      const rotsPC = App.playercard[team].rotations || [];
      const rotsCampo = rotsPC.map(obj=>objToArray(obj));
      if(rotsCampo.length===6) App.campo[team].rotations = rotsCampo;
      App.campo[team].idx = 0; App.campo[team].pts = 0;
    });
    saveAll(); campoPrefillFormsFromState(); campoUpdateCourt(); $('#playPanel').hidden = false; }

  function pcRefreshAll(){ pcBuildRoster(); pcBuildRotations(); pcLoadFromState(); }

  /****************
   *  CAMPO LOGIC * (ispirato al tuo Campo.html)
   ****************/
  const POS_FORM_ORDER = ["SLS","SLC","SLD","FS","FC","FD"]; // moduli
  function campoBuildForms(container, team){ for(let r=1;r<=6;r++){ const wrap=document.createElement('div'); wrap.className='grid g3'; wrap.id=`form_${team}_R${r}`; wrap.setAttribute('aria-hidden','true'); POS_FORM_ORDER.forEach(pos=>{ const box=document.createElement('div'); box.className='grow'; box.innerHTML = `<label>${pos} ¬∑ ID giocatore (R${r})</label><input inputmode="numeric" pattern="[0-9., ]*" type="text" id="in_${team}_R${r}_${pos}" placeholder="es. 29" /><small class="hint" id="h_${team}_R${r}_${pos}">‚Äî</small>`; const input=box.querySelector('input'); input.addEventListener('input', ()=>campoShowHint(team,r,pos,input.value.trim())); wrap.appendChild(box); }); container.appendChild(wrap);} }
  function campoBuildTabs(container, team){ for(let r=1;r<=6;r++){ const b=document.createElement('button'); b.type='button'; b.className='tab'; b.textContent='R'+r; b.dataset.team=team; b.dataset.rot=String(r); b.addEventListener('click', ()=>campoShowRotForm(team,r)); container.appendChild(b);} }
  function campoShowRotForm(team,r){ const tabs=team==='A'?$('#tabsA'):$('#tabsB'); const forms=team==='A'?$('#formsA'):$('#formsB'); Array.from(tabs.children).forEach((el,i)=>el.setAttribute('aria-selected',(i+1)===r?'true':'false')); Array.from(forms.children).forEach((el,i)=>el.setAttribute('aria-hidden',(i+1)===r?'false':'true')); }
  function campoShowHint(team,r,pos,val){ const h=$(`#h_${team}_R${r}_${pos}`); const id=normId(val); if(!id){ h.textContent='‚Äî'; return; } const p=App.playersMap[id]||App.playersMap[id+'.0']; if(!p){ h.innerHTML=`<span class="danger">ID ${id} non trovato</span>`; return; } h.innerHTML = `${escapeHtml(p.Name)} <span class="pill">${escapeHtml(p.Role||'')}</span>`; }

  function campoReadTeamForms(team){ const rots=[]; for(let r=1;r<=6;r++){ const arr=[ normId($(`#in_${team}_R${r}_SLS`).value), normId($(`#in_${team}_R${r}_SLC`).value), normId($(`#in_${team}_R${r}_SLD`).value), normId($(`#in_${team}_R${r}_FD`).value), normId($(`#in_${team}_R${r}_FC`).value), normId($(`#in_${team}_R${r}_FS`).value) ]; if(arr.some(v=>!v)){ alert(`Compila tutti gli ID per ${team} in R${r}.`); return null; } rots.push(arr); } return rots; }
  function campoPrefillFormsFromState(){ ['A','B'].forEach(team=>{ const rots=App.campo[team].rotations||[]; for(let r=1;r<=6;r++){ const arr=rots[r-1]||[]; const map={ SLS:arr[0], SLC:arr[1], SLD:arr[2], FD:arr[3], FC:arr[4], FS:arr[5] }; POS_FORM_ORDER.forEach(pos=>{ const el=$(`#in_${team}_R${r}_${pos}`); if(el){ el.value = map[pos] || ''; campoShowHint(team,r,pos,el.value); } }); } }); }

  // Campo: court rendering
  function campoPlayerAt(team,posLabel){ const t=App.campo[team]; const r=t.rotations[t.idx]||[]; const base = POS_CAMPO.indexOf(posLabel); if(base===-1) return ''; return r[base]; }
  function campoUpdateCourt(){ $('#rotA').textContent='R'+((App.campo.A.idx%6)+1); $('#rotB').textContent='R'+((App.campo.B.idx%6)+1); campoRenderScore(); campoFillSix('A', $('#sixA')); campoFillSix('B', $('#sixB'));  if (typeof computeSideCalcs === 'function') computeSideCalcs(); }
  function campoRenderScore(){ $('#ptsA').textContent=String(App.campo.A.pts); $('#ptsB').textContent=String(App.campo.B.pts); $('#serveA').hidden = App.campo.serving!=='A'; $('#serveB').hidden = App.campo.serving!=='B'; }
  function campoFillSix(team, container){
  container.querySelectorAll('.cell').forEach(cell=>{
    const label = cell.getAttribute('data-pos');          // SLD, SLC, ...
    const id = campoPlayerAt(team, label);                // ID in quella posizione
    const who   = cell.querySelector('.who');
    const role  = cell.querySelector('.roleMini');
    const stats = cell.querySelector('.stats');

    if(!id){
      cell.classList.add('missing');
      who.textContent   = '‚Äî';
      role.textContent  = '';
      stats.textContent = '';
      return;
    }

    const p = App.playersMap[id] || App.playersMap[id+'.0'];
    if(!p){
      cell.classList.add('missing');
      who.textContent   = `ID ${id} (non trovato)`;
      role.textContent  = '';
      stats.textContent = '';
      return;
    }

    cell.classList.remove('missing');

    // << NUOVO HEADER >>
    // Nome + [ID] sulla stessa riga, posizione su riga sotto
    who.innerHTML = `
      <div class="whoRow">
        <span class="nm">${escapeHtml(p.Name)}</span>
        <span class="pid">[${escapeHtml(id)}]</span>
      </div>
      <div class="posSmall">${escapeHtml(label)}</div>
    `;

    // Ruolo e statistiche (immutati)
    role.textContent = `Ruolo: ${p.Role || ''}`;
    const att = `${p.ATK || 0}/${p.SET || 0}`;
    const dif = `${p.BLK || 0}/${p.DEF || 0}/${p.SERV || 0}`;
    stats.innerHTML =
      `<span class="label">F.ATT</span> ${att} ‚Ä¢ ` +
      `<span class="label">F.DIF</span> ${dif}`;
  });
}

  // Score / side-out
  function campoAddPoint(team){ App.campo[team].pts++; if(App.campo.serving!==team) campoDoSideOut(team); saveAll(); campoRenderScore(); }
  function campoDoSideOut(team){
  App.campo[team].idx = (App.campo[team].idx + 1) % 6;
  App.campo.serving = team;
  saveAll();
  // Rimescola il mazzo ad ogni Side-Out
  if (typeof cardsResetShuffle === 'function') cardsResetShuffle();
  campoUpdateCourt();
}
  
  /* ========= SIDE CALC: pannelli + formule ========= */

// Helper sicuri sulle stats
function statById(id, key){
  if(id==null || id==='') return {v:null, name:null, hasKey:false};
  const p = (typeof getPlayerById==='function') ? getPlayerById(id) : null;
  if(!p) return {v:null, name:null, hasKey:false};
  const k = String(key).toUpperCase();
  const hasKey = Object.prototype.hasOwnProperty.call(p, k);
  const v = Number(hasKey ? p[k] : 0);
  return {v: Number.isFinite(v) ? v : 0, name: (p.FullName||p.Name||('ID '+(p.ID??id))), hasKey};
}

function buildSideCalcPanels(){
  const court = document.querySelector('.court');
  if(!court || document.querySelector('.courtWrap')) return;

  // wrapper a 3 colonne: sinistra | campo | destra
  const wrap = document.createElement('div'); wrap.className = 'courtWrap';
  court.parentNode.insertBefore(wrap, court);
  wrap.appendChild(court);

  // Pannello sinistro: SERV Check
  const left = document.createElement('aside');
  left.className = 'sidecalc'; left.id = 'calcLeft';
  left.innerHTML = `
    <div class="group">
      <div class="group-hd">SERV Check</div>
      <label class="idrow">Server ID <input type="number" id="id_serv" placeholder="es. 12"></label>
      <div class="statline">SERV: <b id="val_serv">‚Äî</b> <span id="name_serv"></span></div>
      <div class="divider"></div>
      <label class="idrow">SLD ID <input type="number" id="id_sld" placeholder="rice 1"></label>
      <label class="idrow">SLC ID <input type="number" id="id_slc" placeholder="rice 2"></label>
      <label class="idrow">SLS ID <input type="number" id="id_sls" placeholder="rice 3"></label>
      <div class="statline">DEF SLD/SLC/SLS:
        <b id="val_sld">‚Äî</b> / <b id="val_slc">‚Äî</b> / <b id="val_sls">‚Äî</b></div>
      <div class="statline">Media DEF: <b id="val_def_avg">‚Äî</b></div>
      <div class="result">SERV ‚àí (avg DEF): <b id="out_serv">‚Äî</b></div>
    </div>`;
  wrap.insertBefore(left, court);

  // Pannello destro: ATT Check + VS
  const right = document.createElement('aside');
  right.className = 'sidecalc'; right.id = 'calcRight';
  right.innerHTML = `
  <div class="group">
    <div class="group-hd">ATT Check</div>
    <label class="idrow">Setter ID <input type="number" id="id_setter" placeholder="es. 7"></label>
    <label class="idrow">Attacker ID <input type="number" id="id_att" placeholder="es. 18"></label>
    <label class="idrow">Blocker ID <input type="number" id="id_blk" placeholder="es. 21"></label>
    <label class="idrow">Ricezione (DEF) ID <input type="number" id="id_rec" placeholder="es. 5"></label>
    <div class="statline">
      SET:<b id="val_set">‚Äî</b> ATK:<b id="val_atk">‚Äî</b>
      PIPE(auto):<b id="val_pipe">0</b> BLK:<b id="val_blk">‚Äî</b> DEF:<b id="val_def">‚Äî</b>
    </div>
    <div class="result">
      ATT Check = (SET + ATK ‚àí PIPE) ‚àí BLK ‚Üí <b id="out_att">‚Äî</b>
      <span class="hint" id="hint_pipe" hidden>attaccante in SLD/SLC/SLS ‚Üí ‚àí1 ATK</span>
    </div>
  </div>

  <div class="group">
    <div class="group-hd">Confronti</div>
    <div class="result">VS Muro = ATK ‚àí BLK ‚Üí <b id="out_vsm">‚Äî</b></div>
    <div class="result">VS Ricezione = ATK ‚àí DEF ‚Üí <b id="out_vsr">‚Äî</b></div>
  </div>`;
  wrap.appendChild(right);

  // Eventi input ‚Üí ricalcolo
  ['id_serv','id_sld','id_slc','id_sls','id_setter','id_att','id_blk','id_rec']
  .forEach(id => wrap.querySelector('#'+id).addEventListener('input', computeSideCalcs));

  computeSideCalcs(); // iniziale
}

/* ====== MAZZO AZIONI (18 carte) ====== */
const CARD_DEFS = [
  { id:'SP',  name:'Schiacciata potente', effect:'ATK +1 al colpo',                    count:5 },
  { id:'INC', name:'Incrociata',           effect:'L‚Äôattacco sceglie chi difende',     count:6 },
  { id:'COV', name:'Copertura',            effect:'+1 DEF al difendente',              count:2 },
  { id:'M2',  name:'Muro a 2',             effect:'BLK + (BLK del vicino / 2)',        count:3 },
  { id:'OUT', name:'Palla fuori',          effect:'Punto assegnato alla difesa',       count:2 },
];

function cardsMakeDeck(){
  const deck=[];
  CARD_DEFS.forEach(c=>{ for(let i=0;i<c.count;i++) deck.push(c.id); });
  return cryptoShuffle(deck);
}

function cardsResetShuffle(){
  if(!App.cards) App.cards = {};
  App.cards.deck = cardsMakeDeck();
  App.cards.last = null;
  renderCardsBox();
  saveAll();
}

function drawCard(){
  if(!App.cards || !App.cards.deck || App.cards.deck.length===0) cardsResetShuffle();
  const id = App.cards.deck.pop();
  App.cards.last = CARD_DEFS.find(c=>c.id===id) || null;
  renderCardsBox();
  saveAll();
}

function renderCardsBox(){
  const box = document.getElementById('cardsBox'); if(!box) return;
  const deck = (App.cards?.deck)||[];
  box.querySelector('[data-deckcount]').textContent = String(deck.length);

  // riepilogo rimanenze per tipo
  const remainHTML = CARD_DEFS.map(c=>{
    const n = deck.filter(x=>x===c.id).length;
    return `<span class="cardchip" title="${c.effect}">${c.name} <b>√ó${n}</b></span>`;
  }).join('');
  box.querySelector('[data-remaining]').innerHTML = remainHTML;

  // ultima carta
  const last = App.cards?.last;
  box.querySelector('[data-last]').innerHTML = last
    ? `<div class="name">${last.name}</div><div class="effect">${last.effect}</div>`
    : `<div class="hint">Nessuna carta pescata.</div>`;

  // disabilita pesca se vuoto (anche se al Side-Out si rimescola da solo)
  $('#btnDrawCard').disabled = deck.length===0;
}

function buildCardsBox(){
  const wrap = document.querySelector('.courtWrap');
  if(!wrap || document.getElementById('cardsBox')) return;

  const box = document.createElement('section');
  box.className = 'cardsbox';
  box.id = 'cardsBox';
  box.innerHTML = `
    <div class="cards_head">
      <strong>Mazzo azioni (18)</strong>
      <div class="row">
        <span class="pill">Nel mazzo: <b data-deckcount>18</b></span>
        <button class="btn small" id="btnDrawCard">Pesca carta</button>
        <button class="btn small" id="btnShuffleCards" title="Rimescola manuale (Side-Out lo fa gi√†)">Rimescola</button>
      </div>
    </div>
    <div class="cardview" data-last></div>
    <div class="cards_list" data-remaining></div>
    <div class="hint">Le carte pescate vengono rimosse. Al <b>Side-Out</b> il mazzo si rimescola automaticamente.</div>
  `;
  wrap.appendChild(box);

  document.getElementById('btnDrawCard').addEventListener('click', drawCard);
  document.getElementById('btnShuffleCards').addEventListener('click', cardsResetShuffle);

  // prima visualizzazione
  if(!App.cards || !App.cards.deck) cardsResetShuffle(); else renderCardsBox();
}

// Quale squadra ha in campo l'ID (alla rotazione corrente)?
function teamOfOnCourtId(rawId){
  const id = normId(rawId); if(!id) return null;
  const rA = (App.campo?.A?.rotations?.[App.campo.A.idx]) || [];
  const rB = (App.campo?.B?.rotations?.[App.campo.B.idx]) || [];
  if (rA.some(x => normId(x) === id)) return 'A';
  if (rB.some(x => normId(x) === id)) return 'B';
  return null;
}

// Riempie SLD/SLC/SLS con gli ID della squadra avversaria (se auto)
function autoFillReceiversForServer(){
  const servId = normId(document.querySelector('#id_serv').value);
  if(!servId) return;
  const team = teamOfOnCourtId(servId); if(!team) return;
  const opp = team === 'A' ? 'B' : 'A';
  const ids = {
    sld: normId(campoPlayerAt(opp,'SLD')),
    slc: normId(campoPlayerAt(opp,'SLC')),
    sls: normId(campoPlayerAt(opp,'SLS')),
  };
  ['sld','slc','sls'].forEach(k=>{
    const el = document.querySelector('#id_'+k);
    if(!el) return;
    // Aggiorna se campo vuoto o se era gi√† in modalit√† auto
    const canAuto = !el.value || el.dataset.auto === '1';
    if(canAuto){
      el.value = ids[k] || '';
      el.dataset.auto = '1';
    }
  });
}

// Attacker in back row? (SLD,SLC,SLS su A o B alla rotazione corrente)
function attackerInBackRow(rawId){
  const id = normId(rawId);
  if(!id) return false;
  const isBack = (team) => {
    const r = (App.campo?.[team]?.rotations?.[App.campo[team].idx]) || [];
    // POS_CAMPO = [SLS, SLC, SLD, FD, FC, FS] ‚Üí back row = indici 0,1,2
    return [0,1,2].some(i => normId(r[i]) === id);
  };
  return isBack('A') || isBack('B');
}

// Posizione e squadra dell'ID (sulla rotazione corrente)
function posOfOnCourtId(rawId){
  const id = normId(rawId); if(!id) return null;
  const idxA = App.campo.A.idx, idxB = App.campo.B.idx;
  const rA = (App.campo.A.rotations[idxA]||[]), rB = (App.campo.B.rotations[idxB]||[]);
  const iA = rA.findIndex(x => normId(x)===id);
  if(iA >= 0) return { team:'A', pos: POS_CAMPO[iA] };
  const iB = rB.findIndex(x => normId(x)===id);
  if(iB >= 0) return { team:'B', pos: POS_CAMPO[iB] };
  return null;
}
function oppTeam(t){ return t==='A' ? 'B' : (t==='B' ? 'A' : null); }

// Mappatura posizioni avversarie per BLK/DEF in base alla POS dell‚Äôattaccante
function oppRefsForAttackPos(attPos){
  switch(attPos){
    // Front-row
    case 'FS':  return { blkPos:'FD', defPos:'SLD' };
    case 'FC':  return { blkPos:'FC', defPos:'SLC' };
    case 'FD':  return { blkPos:'FS', defPos:'SLS' };
    // Back-row (PIPE)
    case 'SLD': return { blkPos:'FS', defPos:'SLS' };
    case 'SLC': return { blkPos:'FC', defPos:'SLC' };
    case 'SLS': return { blkPos:'FD', defPos:'SLD' };
    default:    return null;
  }
}

// Auto-riempie BLK/DEF in base all'attaccante e alla rotazione corrente
function autoFillDefBlkForAttacker(){
  const attInput = document.getElementById('id_att');
  if(!attInput) return;
  const attId = normId(attInput.value);
  if(!attId) return;

  const where = posOfOnCourtId(attId);
  if(!where) return; // ID non √® in campo ‚Üí non auto-compilo

  const map = oppRefsForAttackPos(where.pos);
  if(!map) return;   // attaccante non √® FS/FC/FD ‚Üí non auto-compilo

  const opp = oppTeam(where.team);
  if(!opp) return;

  const blkEl = document.getElementById('id_blk');
  const recEl = document.getElementById('id_rec');
  if(blkEl){
    const canAuto = !blkEl.value || blkEl.dataset.auto==='1';
    if(canAuto){
      blkEl.value = normId(campoPlayerAt(opp, map.blkPos)) || '';
      blkEl.dataset.auto = '1';
    }
  }
  if(recEl){
    const canAuto = !recEl.value || recEl.dataset.auto==='1';
    if(canAuto){
      recEl.value = normId(campoPlayerAt(opp, map.defPos)) || '';
      recEl.dataset.auto = '1';
    }
  }
}

function computeSideCalcs(){
  const $ = s => document.querySelector(s); autoFillReceiversForServer(); autoFillDefBlkForAttacker();

  // --- SERV Check: SERV ‚àí [(SLD DEF + SLC DEF + SLS DEF)/3]
  const serv = statById($('#id_serv').value, 'SERV');
  $('#val_serv').textContent = (serv.v==null ? '‚Äî' : serv.v);
  $('#name_serv').textContent = serv.name || '';

  const sld = statById($('#id_sld').value, 'DEF');
  const slc = statById($('#id_slc').value, 'DEF');
  const sls = statById($('#id_sls').value, 'DEF');
  $('#val_sld').textContent = (sld.v==null ? '‚Äî' : sld.v);
  $('#val_slc').textContent = (slc.v==null ? '‚Äî' : slc.v);
  $('#val_sls').textContent = (sls.v==null ? '‚Äî' : sls.v);

  const defs = [sld.v, slc.v, sls.v].filter(v => v!=null);
  const avgDef = defs.length ? (defs.reduce((a,b)=>a+b,0) / defs.length) : null;
  $('#val_def_avg').textContent = (avgDef==null ? '‚Äî' : avgDef.toFixed(2));
  const servOut = (serv.v!=null && avgDef!=null) ? (serv.v - avgDef) : null;
  $('#out_serv').textContent = (servOut==null ? '‚Äî' : servOut.toFixed(2));

  // --- ATT Check: (SET + ATK ‚àí PIPE) ‚àí BLK  con PIPE=1 se attaccante √® in SLD/SLC/SLS, altrimenti 0
const set = statById($('#id_setter').value, 'SET');
const atk = statById($('#id_att').value, 'ATK');
const blk = statById($('#id_blk').value, 'BLK');
const rec = statById($('#id_rec').value, 'DEF');

// PIPE auto da posizione in campo
const pipeDebuff = attackerInBackRow($('#id_att').value) ? 1 : 0;
$('#val_set').textContent  = (set.v==null ? '‚Äî' : set.v);
$('#val_atk').textContent  = (atk.v==null ? '‚Äî' : atk.v);
$('#val_pipe').textContent = String(pipeDebuff);
$('#val_blk').textContent  = (blk.v==null ? '‚Äî' : blk.v);
$('#val_def').textContent  = (rec.v==null ? '‚Äî' : rec.v);
$('#hint_pipe').hidden = !pipeDebuff;

// ATK effettivo con debuff PIPE
const atkEff = (atk.v!=null) ? (atk.v - pipeDebuff) : null;

// ATT Check = (SET + ATK ‚àí PIPE) ‚àí BLK  ‚Üí (SET + atkEff) ‚àí BLK
const attOut = (set.v!=null && atkEff!=null && blk.v!=null)
  ? ((set.v + atkEff) - blk.v)
  : null;
$('#out_att').textContent = (attOut==null ? '‚Äî' : attOut.toFixed(2));

// --- VS Muro / VS Ricezione con ATK effettivo
const vsm = (atkEff!=null && blk.v!=null) ? (atkEff - blk.v) : null;
const vsr = (atkEff!=null && rec.v!=null) ? (atkEff - rec.v) : null;
$('#out_vsm').textContent = (vsm==null ? '‚Äî' : vsm.toFixed(2));
$('#out_vsr').textContent = (vsr==null ? '‚Äî' : vsr.toFixed(2));
}

  /***************
   *  BOOTSTRAP  *
   ***************/
  function boot(){ buildTabs(); uiBuildRoleInputs(); updatePoolInfo(); autoLoadPlayers();
    // Top bar
    $('#btnReloadPlayers').addEventListener('click', autoLoadPlayers);
    $('#fileInput').addEventListener('change', handleUserFile);
    $('#btnSaveAll').addEventListener('click', ()=>{ saveAll(); alert('Salvato!'); });
    $('#btnResetAll').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); });

    // Sorteggio
    $('#drawBtn').addEventListener('click', drawTeams);
    $('#reshuffleBtn').addEventListener('click', drawTeams);
    $('#copyBtn').addEventListener('click', copyTeamsToClipboard);
    $('#csvBtn').addEventListener('click', downloadCSV);
    $('#btnSendToPlayercard').addEventListener('click', sendToPlayercard);
    $('#btnSendToCampo').addEventListener('click', sendToCampo);

    // Playercard UI
    $('#pcTeamSel').addEventListener('change', ()=>{ pcStoreRoster(); pcStoreRotations(); pcRefreshAll(); pcLoadFromState(); });
    $('#btnAutoR1').addEventListener('click', ()=>autoComposeR1(pcTeam()));
    $('#btnToCampo').addEventListener('click', pcPushRotationsToCampo);

    // Build PC UI
    pcBuildRoster(); pcBuildRotations();

    // Campo build forms/tabs
    campoBuildTabs($('#tabsA'),'A'); campoBuildTabs($('#tabsB'),'B'); campoBuildForms($('#formsA'),'A'); campoBuildForms($('#formsB'),'B'); campoShowRotForm('A',1); campoShowRotForm('B',1); buildSideCalcPanels(); buildCardsBox();

    // Campo buttons
    $('#btnSaveRot').addEventListener('click', ()=>{ const A=campoReadTeamForms('A'); const B=campoReadTeamForms('B'); if(!A||!B) return; App.campo.A.rotations=A; App.campo.A.idx=0; App.campo.A.pts=0; App.campo.B.rotations=B; App.campo.B.idx=0; App.campo.B.pts=0; saveAll(); // servizio dialog
      if(typeof dlgServe.showModal==='function'){ dlgServe.showModal(); dlgServe.addEventListener('close', ()=>{ App.campo.serving = (dlgServe.returnValue==='B')?'B':'A'; saveAll(); campoUpdateCourt(); $('#playPanel').hidden=false; }, {once:true}); } else { App.campo.serving = confirm('Inizia al servizio A? (Annulla=B)')?'A':'B'; campoUpdateCourt(); $('#playPanel').hidden=false; }
    });
    $('#btnClearLS').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); });
    $('#plusA').addEventListener('click', ()=>campoAddPoint('A')); $('#plusB').addEventListener('click', ()=>campoAddPoint('B')); $('#soA').addEventListener('click', ()=>campoDoSideOut('A')); $('#soB').addEventListener('click', ()=>campoDoSideOut('B'));
	
	// Se l'utente cambia a mano SLD/SLC/SLS, disattiva l'auto per quel campo
['id_sld','id_slc','id_sls'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', e => { e.target.dataset.auto = ''; });
});

['id_blk','id_rec'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', e => { e.target.dataset.auto = ''; });
});

    // restore project if exists
    if(loadAll()){
      // Re‚Äëingest players (in caso fossero obsoleti nel salvataggio)
      if(App.playersArr?.length){ const raw = {}; App.playersArr.forEach(p=>{ raw[p.id] = { ID:p.id, FullName:p.name, Role:p.role }; }); ingestPlayers(raw); }
      // Playercard
      pcRefreshAll(); pcLoadFromState();
      // Campo
      campoPrefillFormsFromState(); campoUpdateCourt(); if((App.campo?.A?.rotations||[]).every(r=>Array.isArray(r)&&r.every(Boolean))) $('#playPanel').hidden=false;
      // Sorteggio result visual
      if(App.sorteggio) renderTeams(App.sorteggio.A||[], App.sorteggio.B||[]);
    }
  }

  // File input handler (JSON/Excel/CSV)
  async function handleUserFile(e){ const f=e.target.files?.[0]; if(!f) return; try{ const ext=(f.name.split('.').pop()||'').toLowerCase(); let raw=null; if(ext==='json'){ raw=JSON.parse(await f.text()); } else if(ext==='xlsx'||ext==='xls'){ const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; raw=XLSX.utils.sheet_to_json(ws,{defval:''}); } else if(ext==='csv'){ const txt=await f.text(); raw=csvToJSON(txt); } else { alert('Formato non supportato'); return; } ingestPlayers(raw); saveAll(); }catch(err){ console.error(err); alert('Errore nel caricamento: '+err.message); } finally { e.target.value=''; } }
  function csvToJSON(text){ const rows=text.replace(/\r/g,'').split('\n').filter(Boolean); const headers=rows.shift().split(',').map(h=>h.trim()); return rows.map(r=>{ const cols=r.split(','); const obj={}; headers.forEach((h,i)=>obj[h]=(cols[i]??'').trim()); return obj; }); }

  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
